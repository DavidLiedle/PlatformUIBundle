<link rel="import" href="../vendors/polymer/polymer-element.html">

<script>
(function () {
    function fetchUpdate(updateUrl) {
        var headers;

        headers = new Headers({
            'X-AJAX-Update': '1',
        });
        return fetch(updateUrl, {
            credentials: 'same-origin',
            headers: headers,
        }).then(function (response) {
            return response.json();
        }).then(function (struct) {
            struct.url = updateUrl;

            return struct;
        });
    }

    function updateElement(element, updateStruct) {
        if ( typeof updateStruct === "string" ) {
            element.outerHTML = updateStruct;
        } else if ( updateStruct ) {
            let attributes = updateStruct.attributes || {},
                children = updateStruct.children || [];

            Object.keys(attributes).forEach(function (attributeName) {
                element.setAttribute(attributeName, attributes[attributeName]);
            });
            children.forEach(function (childUpdate) {
                if ( childUpdate ) {
                    const child = element.querySelector(childUpdate.selector);

                    if ( child ) {
                        updateElement(child, childUpdate.update);
                    } else {
                        console.warn(`Unable to find ${childUpdate.selector} under`, element);
                    }
                }
            }, element);
        }
        return updateStruct;
    }

    function replaceHistory(struct) {
        history.pushState({url: struct.url}, struct.title, struct.url);

        return struct;
    }


    document.addEventListener('click', function (e) {
        if ( e.target.classList.contains('run-udw') ) {
            const button = e.target;
            const event = new CustomEvent('contentDiscover', {
                detail: {
                    title: "UDW tests (multiple, allow only container)",
                    multiple: true,
                    oncancel: function () {
                        console.log('CANCEL');
                    },
                    onconfirm: function (items) {
                        var list = document.createElement('ul');
                        items.forEach(function (selection) {
                            const result = document.createElement('li');

                            result.innerHTML = `${selection.location.contentInfo.name}
                                (Content id #${selection.content.contentId}) in Location
                                #${selection.location.locationId}
                                (${selection.location.pathString}) was
                                chosen (Type ${selection.contentType.names['eng-GB']})`;

                            list.appendChild(result);
                        });
                        button.parentNode.insertBefore(list, button);
                    },
                    isSelectable: function (item) {
                        return item.contentType.isContainer;
                    },
                },
                bubbles: true,
            });
            button.dispatchEvent(event);
        }
    });

    class PlatformUIApp extends Polymer.Element {
        static get is() {
            return 'ez-platformui-app';
        }

        static get config() {
            return {
                properties: {
                    updating: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false,
                    },
                    title: {
                        type: String,
                        reflectToAttribute: true,
                        value: "",
                    },
                }
            };
        }

        constructor() {
            super();
        }

        connectedCallback() {
            super.connectedCallback();
            this._enhanceNavigation();
            this._listenToBrowseToContent();
            this._listenToContentDiscover();
        }

        disconnectedCallback() {
            super.disconnectedCallback();
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if ( name === "title" ) {
                this.ownerDocument.title = newValue;
            }
        }

        _update(updateUrl) {
            this.updating = true;

            fetchUpdate(updateUrl)
                .then(replaceHistory)
                .then(this._buildUpdateStruct.bind(this, updateUrl))
                .then(updateElement.bind(null, this))
                .then(function (struct) {
                    this.updating = false;

                    return struct;
                }.bind(this));
        }

        _buildUpdateStruct(url, struct) {
            var updateStruct = {};

            // building an update struct to use updateElement()
            // but the server should directly do that.
            updateStruct.attributes = {
                title: struct.title,
            };

            updateStruct.children = struct.toolbars.concat();
            updateStruct.children.push(struct.mainContent);
            updateStruct.children.push(struct.navigationHub);

            return updateStruct;
        }

        _enhanceNavigation() {
            this.addEventListener('click', function (e) {
                var updateUrl;

                function isNavigationLink(element) {
                    // we should probably further check the URI (same origin ?)
                    // we should also allow to opt out from that with a class
                    return element.nodeName === 'A' && element.href && element.getAttribute('href').indexOf('#') !== 0
                }

                if ( isNavigationLink(e.target) ) {
                    updateUrl = e.target.href;
                    e.preventDefault();
                    this._update(e.target.href);
                }
            }.bind(this));
            window.addEventListener('popstate', function (e) {
                if ( e.state && e.state.url ) {
                    this._update(e.state.url);
                }
            }.bind(this));
        }

        _listenToBrowseToContent() {
            this.addEventListener('browseToContent', function (e) {
                const uri = Routing.generate(
                    'proto_viewLocation',
                    {"locationId": e.detail.location.locationId}
                );

                this._update(uri);
            }.bind(this));
        }

        _listenToContentDiscover() {
            this.addEventListener('contentDiscover', function (e) {
                const udw = document.createElement('ez-universaldiscoverywidget');

                udw.title = e.detail.title;
                udw.multiple = e.detail.multiple;
                udw.onconfirm = function (selection) {
                    e.detail.onconfirm.call(udw, selection);
                    // removing the UDW is a bit brutal as this prevents
                    // any kind of animation when hiding the UDW.
                    udw.remove(true);
                }
                udw.oncancel = function (selection) {
                    if ( e.detail.oncancel ) {
                        e.detail.oncancel.call(udw, selection);
                    }
                    udw.remove(true);
                }
                udw.isSelectable = e.detail.isSelectable ? e.detail.isSelectable : undefined;
                udw.startingLocationId = e.detail.startingLocationId;
                // that way existing PlatformUI stylesheets work out of the box
                udw.classList.add('ez-universaldiscovery-container');
                this.appendChild(udw);
            }.bind(this));
        }
    }

    customElements.define(PlatformUIApp.is, PlatformUIApp);
})();
</script>
